<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Angel's Eye - Threat Intelligence Tool</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindplus/elements@1" type="module"></script>

   
    <!-- Google Fonts: Poppins (for the Gemini feel) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- MapLibre GL (replaces Leaflet for map base & overlays) -->
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    

    <!-- Turf.js for Geospatial Analysis -->
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script src='https://storage.ko-fi.com/cdn/scripts/overlay-widget.js'></script>

    

    <style>
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(to right, #141414, #3d4141); background-size: cover; background-position: center;}
        #map { height: 100%; width: 100%; border-radius: 0.5rem; }
        .leaflet-container { background: #1f2937; }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: #1d222b; color: #e5e7eb; border-radius: 0.5rem; }
        .loader { border: 5px solid #374151; border-top: 5px solid #1ebdc9; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-btn.active { background: linear-gradient(#12729e, #0e4b72); color: white; }
        .tab-btn-monitor.active { background: linear-gradient(#9e1264, #720e4c); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-content-monitor { display: none; }
        .tab-content-monitor.active { display: block; }
        .threat-list-item:hover { background-color: #374151; }
        /* --- Custom Dark Scrollbar Styles --- */
  /* Works on Firefox */
  * {
    scrollbar-width: thin;
    scrollbar-color: #555 #2c2c2c;
    }

    /* Works on Chrome, Edge, and Safari */
    *::-webkit-scrollbar {
      width: 12px;
    }

    *::-webkit-scrollbar-track {
      background: #2c2c2c;
    }

    *::-webkit-scrollbar-thumb {
      background-color: #555;
      border-radius: 20px;
      border: 3px solid #2c2c2c;
    }

    *::-webkit-scrollbar-thumb:hover {
      background-color: #777;
    }
    .text-muted, .form-control::placeholder {
      color: #cccccc8a !important;
    }
    .dropdown-menu {
      min-width: 200px;
      animation: fadeInDown 0.3s ease-in-out;
    }
    /* Splash modal styles */
    #splashModal {
        position: fixed;
        inset: 0;
        display: none; /* shown by JS when unauthenticated */
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,0.7);
        z-index: 9999;
        padding: 1rem;
    }
    #splashModal .modal-card { background: linear-gradient(180deg,#223e42,#111725); border-radius: 0.75rem; padding: 2rem; max-width: 520px; color: #e5e7eb; animation: neon-light 1.5s infinite alternate; }
    body.modal-open { overflow: hidden; }
    
    @keyframes fadeInDown {
      0% {
        opacity: 0;
        transform: translateY(-10px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes neon-light
    {
      0% {
        box-shadow:  #61cfe233 0px 0px 5px, 0 0 10px #61cfe233, 0 0 15px #61cfe233, 0 0 20px #61cfe233;
      }
      10% {
        box-shadow: 0 0 10px #61cfe233, 0 0 15px #61cfe233, 0 0 20px #61cfe233, 0 0 25px #61cfe233;
      }
    }
    </style>
</head>
<body class="text-gray-200 d-flex flex-column min-vh-100 h-full">
        <!-- Firebase (v8 namespaced) and app auth script -->
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
        <script src="./micro-defense/angel-eye1/index.js"></script>


    <!-- Splash modal: forces sign in before using the app -->
   <div id="splashModal" aria-hidden="true">
        <div class="modal-card">
            <div class="flex items-center space-x-4 mb-4">
                <img src="https://raw.githubusercontent.com/ranggafermata/angel-eye-app/994382a958b0ec436031db54c0956eff505f5548/angel%20eye%20logo0001.png" alt="Logo" class="h-14 w-14 rounded-full">
                <div>
                    <h2 class="text-2xl font-bold">Welcome to Angel's Eye</h2>
                    <p class="text-sm text-gray-400">Sign in with Google to continue.</p>
                </div>
            </div>
            <div class="mt-2">
                <button id="splashSignInBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center">
                    <i class="fa-brands fa-google mr-2"></i> Sign in with Google
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-3">You must sign in to access the platform. This dialog cannot be dismissed until you sign in.</p>
        </div>
    </div>

    <div class="p-6 space-y-6">
        <!-- Header -->
        <header class="mb-6 flex items-center justify-between border-b border-gray-700 pb-4">
            <div>
                <div class="flex items-center">
                    <!-- Custom Logo - Fixed URL -->
                    <img src="https://raw.githubusercontent.com/ranggafermata/angel-eye-app/994382a958b0ec436031db54c0956eff505f5548/angel%20eye%20logo0001.png" alt="Angel's Eye Logo" class="h-12 w-12 mr-3">
                     <!-- Gradient Title -->
                    <h1 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-white-500">
                        Angel's Eye
                    </h1>
                </div>
                <p class="text-gray-400 mt-1 ml-1">Live Monitoring & Threat Intelligence Tool</p>
            </div>
            
             <div class="flex items-center space-x-4">
                <div id="status-indicator" class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                    <span class="text-sm text-gray-300">System Nominal</span>
                </div>

                <!-- Profile dropdown (updated by index.js on auth change) -->
                <div id="userDropdown" class="relative ml-4">
                    <button id="userDropdownBtn" class="flex items-center space-x-2 bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded-lg focus:outline-none">
                        <img id="userAvatar" src="https://www.gravatar.com/avatar/?d=mp&s=64" alt="avatar" class="h-8 w-8 rounded-full">
                        <span id="userName" class="text-sm text-gray-200">Sign in</span>
                        <i class="fa-solid fa-caret-down text-gray-300 ml-1"></i>
                    </button>
                    <div id="userMenu" class="dropdown-menu hidden absolute right-0 mt-2 bg-gray-900 text-gray-100 rounded shadow-lg p-2">
                        <div id="userInfo" class="p-2 border-b border-gray-700 hidden"></div>
                        <button id="signinOption" class="w-full text-left p-2 hover:bg-gray-800">Sign in with Google</button>
                        <button id="signoutOption" class="w-full text-left p-2 hover:bg-gray-800 hidden">Sign out</button>
                    </div>
                </div>
            </div>
            
        </header>

        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 border-b border-gray-700 pb-4">

            <!-- Left Column: Map & Threat List -->
            <div class="lg:col-span-2 flex flex-col gap-6">
                <!-- Map Panel -->
                <div class=" p-4 rounded-lg shadow-lg h-[600px] w-[900px]  flex flex-col" style="background: linear-gradient(to right, #16191a, #4a4a53); box-shadow: 0 0 10px #61cfe233, 0 0 20px #61cfe233">
                    <h2 class="text-xl font-semibold mb-3 flex items-center"><i class="fa-solid fa-map-location-dot mr-2"></i>Monitor</h2>
                    <div class="flex border-b border-gray-700 mb-4">
                    <button id="mappingBtn" class="tab-btn-monitor active flex-1 text-center py-2 px-4 font-semibold transition" data-tab="map">IP Location Mapping</button>
                    <button id="scanHistoryBtn" class="tab-btn-monitor flex-1 text-center py-2 px-4 font-semibold transition" data-tab="scanHistory">Scan History</button>
                    <button id="wazeMapBtn" class="tab-btn-monitor flex-1 text-center py-2 px-4 font-semibold transition" data-tab="wazeMap">Live Map | Waze</button>
                </div>
                    <div id="map" class="flex-grow" style="border: 0; box-shadow: 0 0 10px #0b101133, 0 0 20px #0e131433, 0 0 30px #0d121333;"></div>
                    <div id="scanHistory" class="bg-gray-800 p-4 rounded-lg shadow-lg h-[500px] max-h-[500px] overflow-y-auto" style="background: linear-gradient(to bottom right, #2b363a, #3b3b52); display: none;">
                    <h2 class="text-xl font-semibold mb-3 flex items-center"><i class="fa-solid fa-list-ul mr-2"></i>Scan History</h2>
                    <ul id="threatList" class="space-y-2 max-h-60 overflow-y-auto">
                        <li id="threatPlaceholder" class="text-gray-500">No History</li>
                        </ul>
                    </div>
                    
                    <iframe id="wazeMap" src="https://embed.waze.com/iframe?zoom=14&lat=-6.917464&lon=107.619123&ct=livemap" style="display: none;" class="rounded-lg shadow-lg"  width="868" height="480" allowfullscreen></iframe>
                    
                </div>
                <!-- Quick Scan Bar -->
        <div class="mb-6 flex flex-col sm:flex-row items-center gap-4">
            <input type="text" id="quickScanInput" class="w-full bg-gray-700 text-gray-200 border border-gray-600 rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500" style="background: linear-gradient(to bottom right, #2b363a, #3b3b52); box-shadow: 0 0 10px #1a1c1d33" placeholder="Enter IP Address or Domain for quick scan...">
            <button id="quickScanBtn" class="w-full sm:w-auto bg-cyan-600 hover:bg-cyan-200 text-white font-bold py-3 px-6 rounded-lg transition flex items-center justify-center">
                <i class="fa-solid fa-search mr-2"></i> Scan
            </button>
            
        </div>

            </div>
            

            <!-- Right Column: Threat Intelligence -->
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg flex flex-col lg:col-span-1 h-full h-[600px] w-[900px] " style="background: linear-gradient(to bottom left, #4e4b4e, #1a1a24); box-shadow: 0 0 10px #61cfe233, 0 0 20px #61cfe233">
                <h2 class="text-xl font-semibold mb-3 flex items-center"><i class="fa-solid fa-shield-virus mr-2"></i> Threat Intelligence</h2>
                <!-- Tabs -->
                <div class="flex border-b border-gray-700 mb-4">
                    <button id="copilotAi" class="tab-btn active flex-1 text-center py-2 px-4 font-semibold transition" data-tab="aiAnalysisTab">AI Analysis</button>
                    <button id="otxScanBtn" class="tab-btn flex-1 text-center py-2 px-4 font-semibold transition" data-tab="otxScanTab">Domain Scan</button>
                </div>
                <!-- AI Analysis Tab -->
                 <div id="aiAnalysisTab" class="tab-content active flex flex-col h-full">
                    <textarea id="threatReportInput" rows="12" class="w-full h-32 bg-gray-700 text-gray-200 border border-gray-600 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500 max-h-32 overflow-y-auto" placeholder="Paste threat report here..."></textarea>
                    <button id="analyzeTextBtn" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center">
                        <i class="fa-solid fa-brain mr-2"></i> Analyze Report
                    </button>
                    <hr class="my-4 border-gray-600">
                    <h3 class="font-semibold text-lg mb-2">AI Summary & IOCs:</h3>
                    <div id="textResult" class="flex-grow bg-gray-900 p-4 rounded-lg overflow-y-auto min-h-[200px] max-h-[200px]">Awaiting analysis...
                        <div id="textLoader" class="hidden self-center my-4"><div class="loader"></div></div>
                    </div>
                </div>

                    
                <!-- OTX Scan Tab -->
                <div id="otxScanTab" class="tab-content flex flex-col h-full" style="display: none">
                    <h3 class="font-semibold text-lg mb-2">Scan Results:</h3>
                    <div id="otxResult" class="flex-grow bg-gray-900 p-4 rounded-lg overflow-y-auto min-h-[430px] max-h-[430px]">Scan an IOC to see results here.
                        <div id="otxLoader" class="hidden self-center my-4"><div class="loader"></div></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 lg:grid-cols-2 gap-2">
            <div class=" p-4 rounded-lg  flex flex-col lg:col-span-1 h-full h-[900px] w-[900px]" style="background: linear-gradient(to bottom left, #4e4b4e, #1a1a24); box-shadow: 0 0 10px #61cfe233, 0 0 20px #61cfe233">
                <div class="flex items-center">
                <h4 class="text-xl font-semibold mb-3 flex items-center"><i class="fa-solid fa-globe mr-2"></i>Live Earth Cams</h4>
                </div>
                <div class="flex-grow mb-4 border-b border-gray-700 pb-4">
                <iframe src="//www.earthcamtv.com/embed.php?4&sz=1&width=1280&height=720&to=0" width="865" height="490"  class="rounded-lg shadow-lg" style="border: 0; box-shadow: 0 0 10px #0b101133, 0 0 20px #0e131433, 0 0 30px #0d121333" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
             </div>
                <h2 class="text-xl font-semibold mb-3 flex items-center"><i class="fa-solid fa-newspaper mr-2 "></i>CISA - Publication</h2>
               <iframe style="border: 0px solid #777; box-shadow: 0 0 10px #0b101133, 0 0 20px #0e131433, 0 0 30px #0d121333"  class="rounded-lg shadow-lg" src="https://indd.adobe.com/embed/12eb85bc-f137-4073-ae12-70acfa8b9e26?startpage=1&allowFullscreen=true" width="865px" height="490px" frameborder="0" allowfullscreen=""></iframe>
                
            </div>
      
        <script
        type="module"
        src="https://gradio.s3-us-west-2.amazonaws.com/5.49.1/gradio.js"
        ></script>
        <gradio-app src="https://prithivmlmods-multimodal-ocr.hf.space"></gradio-app>
    
        </div>


        <script src='https://storage.ko-fi.com/cdn/scripts/overlay-widget.js'></script>
        <script>
        kofiWidgetOverlay.draw('ranggafermata', {
            'type': 'floating-chat',
            'floating-chat.donateButton.text': 'Roger that!',
            'floating-chat.donateButton.background-color': '#ffffff',
            'floating-chat.donateButton.text-color': '#323842'
        });
        </script>

    </div>

    <!-- Footer -->
  <footer class="text-center text-muted py-3 small" style="position: relative; bottom: 0; width: 100%;">
    © <span id="year"></span> Angel's Eye I v.1.4.2 — Bangorinas | Micro-Defense
  </footer>

    <script>
      (function () {
        const copilotAi = document.getElementById('copilotAi');
        const otxScanBtn = document.getElementById('otxScanBtn');
        const aiTab = document.getElementById('aiAnalysisTab');
        const otxTab = document.getElementById('otxScanTab');

        const mappingTab = document.getElementById('map');
        const scanHistoryTab = document.getElementById('scanHistory');
        const wazeMapTab = document.getElementById('wazeMap');
        const mappingBtn = document.getElementById('mappingBtn');
        const scanHistoryBtn = document.getElementById('scanHistoryBtn');
        const wazeMapBtn = document.getElementById('wazeMapBtn');

        function setActiveTab(activeBtn, activeTab) {
          [copilotAi, otxScanBtn ].forEach(btn => btn.classList.remove('active'));
          [aiTab, otxTab].forEach(tab => tab.classList.remove('active'));
          activeBtn.classList.add('active');
          activeTab.classList.add('active');
        }

        function setActiveTabMonitor(activeMonitorBtn, activeMonitorTab) {
          [mappingBtn, scanHistoryBtn, wazeMapBtn].forEach(btn => btn.classList.remove('active'));
          [mappingTab, scanHistoryTab, wazeMapTab].forEach(tab => tab.classList.remove('active'));
          activeMonitorBtn.classList.add('active');
          activeMonitorTab.classList.add('active');
        }

        function showTabContent(tab) {
          aiTab.style.display = 'none';
          otxTab.style.display = 'none';
          tab.style.display = 'block';
        }

        function showTabContentMonitor(tabMonitor) {
          mappingTab.style.display = 'none';
          scanHistoryTab.style.display = 'none';
          wazeMapTab.style.display = 'none';
          tabMonitor.style.display = 'block';
        }

        otxScanBtn.addEventListener('click', () => {
          setActiveTab(otxScanBtn, otxTab);
          showTabContent(otxTab);
        });

        copilotAi.addEventListener('click', () => {
          setActiveTab(copilotAi, aiTab);
          showTabContent(aiTab);
        });

        mappingBtn.addEventListener('click', () => {
          setActiveTabMonitor(mappingBtn, mappingTab);
          showTabContentMonitor(mappingTab);
        });

        scanHistoryBtn.addEventListener('click', () => {
          setActiveTabMonitor(scanHistoryBtn, scanHistoryTab);
          showTabContentMonitor(scanHistoryTab);
        });

        wazeMapBtn.addEventListener('click', () => {
          setActiveTabMonitor(wazeMapBtn, wazeMapTab);
          showTabContentMonitor(wazeMapTab);
        });


      })();

    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // UPDATED: Use a relative path. This works locally (with `vercel dev`) and in production.
            const BACKEND_URL = ''; 
            // Initialize MapLibre GL map. We'll fetch local `style.json` and inject
            // the MapTiler key into any `{key}` placeholders. Map center uses
            // [lng, lat] while the original Leaflet used [lat, lng].

            const map = new maplibregl.Map({
                container: 'map',
                style: {
                    version: 8,
                    sources: {},
                    layers: []
                },
                center: [0, 20], // [lng, lat]
                zoom: 2
            });

            let plottedThreats = {}; // To store threat data, markers and source/layer ids

            // Utility: safe id generator for sources/layers derived from IOC
            function safeId(prefix, ioc) {
                return `${prefix}-${ioc.replace(/[^a-zA-Z0-9-_]/g, '_')}`;
            }

            // Load server config (/api/config) and then local style.json, replace {key}
            // placeholders and set as map style
            let MAPTILER_KEY = '';
            (async function initStyle() {
                try {
                    // Request minimal client-safe config from the server
                    const cfgResp = await fetch('/api/config');
                    if (cfgResp.ok) {
                        const cfg = await cfgResp.json();
                        MAPTILER_KEY = cfg.maptilerKey || '';
                    }
                } catch (e) {
                    console.warn('Could not fetch /api/config — continuing without server config', e);
                }

                try {
                    const resp = await fetch('style.json');
                    if (!resp.ok) throw new Error('Could not load style.json');
                    let styleObj = await resp.json();
                    const replaced = JSON.stringify(styleObj).replace(/\{key\}/g, MAPTILER_KEY);
                    styleObj = JSON.parse(replaced);
                    map.setStyle(styleObj);
                } catch (err) {
                    console.warn('Failed to load MapTiler GL style (style.json). Using default blank style.', err);
                }
            })();

            // Ensure the map's style is loaded before adding sources/layers
            function ensureStyleLoaded() {
                return new Promise((resolve) => {
                    try {
                        if (map.isStyleLoaded && map.isStyleLoaded()) return resolve();
                    } catch (e) {
                        // ignore
                    }
                    map.once('styledata', () => resolve());
                });
            }

            // --- Element References ---
            const quickScanInput = document.getElementById('quickScanInput');
            const quickScanBtn = document.getElementById('quickScanBtn');
            const threatReportInput = document.getElementById('threatReportInput');
            const analyzeTextBtn = document.getElementById('analyzeTextBtn');
            const textResult = document.getElementById('textResult');
            const textLoader = document.getElementById('textLoader');
            const otxResult = document.getElementById('otxResult');
            const otxLoader = document.getElementById('otxLoader');
            const threatList = document.getElementById('threatList');
            const threatPlaceholder = document.getElementById('threatPlaceholder');
        

            // No Leaflet icons — create marker element on the fly when plotting.

            // --- Tab Switching Logic ---
            const tabs = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    tabs.forEach(item => item.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    document.getElementById(e.currentTarget.dataset.tab).classList.add('active');
                });
            });
            
            // --- Quick Scan Logic ---
            quickScanBtn.addEventListener('click', () => {
                const ioc = quickScanInput.value.trim();
                if (!ioc) return;
                const type = getIocType(ioc);
                if (type.api === 'unknown') {
                    alert('Could not determine IOC type. Please enter a valid IP, Domain, URL, or Hash.');
                    return;
                }
                document.querySelector('.tab-btn[data-tab="otxScanTab"]').click();
                queryOtx(ioc, type.api, type.gui);
            });

            // --- Text Report & IOC Analysis ---
            analyzeTextBtn.addEventListener('click', async () => {
                const reportText = threatReportInput.value;
                if (!reportText.trim()) return alert('Please enter text to analyze.');
                textResult.innerHTML = '';
                textLoader.classList.remove('hidden');
                analyzeTextBtn.disabled = true;
                try {
                    const prompt = `As a threat analyst, analyze the report below. Provide a summary, threat level, and a list of IOCs (URL, Domain, IP, Hash). Report: "${reportText}"`;
                    
                    const response = await fetch(`${BACKEND_URL}/api/text`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt })
                    });
                    
                    if (!response.ok) {
                         const errorBody = await response.json();
                        throw new Error(`API request failed: ${response.status} - ${errorBody.error || 'Unknown error'}`);
                    }
                    const result = await response.json();
                    renderAnalysis(result.candidates[0].content.parts[0].text);
                } catch (error) {
                    textResult.textContent = `Analysis Error: ${error.message}`;
                } finally {
                    textLoader.classList.add('hidden');
                    analyzeTextBtn.disabled = false;
                }
            });

            function renderAnalysis(text) {
                const iocRegex = /(\b(?:https?:\/\/[^\s,]+)|[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}|\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b|[a-fA-F0-9]{32,})\b/g;
                const html = text.replace(iocRegex, (match) => {
                    const type = getIocType(match);
                    if (type.api === 'unknown') return match;
                    return `${match} <button class="otx-scan-btn bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded" data-ioc="${match}" data-api-type="${type.api}" data-gui-type="${type.gui}">Scan</button>`;
                }).replace(/\n/g, '<br>');
                textResult.innerHTML = html;
            }
            
            function getIocType(ioc) {
                if (/^https?:\/\//.test(ioc)) return { api: 'url', gui: 'url' };
                if (/^\d{1,3}(\.\d{1,3}){3}$/.test(ioc)) return { api: 'IPv4', gui: 'ip' };
                if (/(?:[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?\.)+[a-z0-9][a-z0-9-]{0,61}[a-z0-9]/.test(ioc) && !ioc.includes('/')) return { api: 'domain', gui: 'domain' };
                if (/[a-fA-F0-9]{32,64}/.test(ioc)) return { api: 'file', gui: 'file' };
                return { api: 'unknown', gui: 'unknown' };
            }

            // --- OTX Scan, Geolocation, and Threat List Logic ---
            document.body.addEventListener('click', function(event) {
                if (event.target.closest('.otx-scan-btn')) {
                    const button = event.target.closest('.otx-scan-btn');
                    const ioc = button.dataset.ioc;
                    const apiType = button.dataset.apiType;
                    const guiType = button.dataset.guiType;
                    document.querySelector('.tab-btn[data-tab="otxScanTab"]').click();
                    queryOtx(ioc, apiType, guiType);
                }
                if (event.target.closest('.threat-list-item')) {
                    const ioc = event.target.closest('.threat-list-item').dataset.ioc;
                    if (plottedThreats[ioc]) {
                        const { lat, lon } = plottedThreats[ioc];
                        // MapLibre expects [lng, lat]
                        map.flyTo({ center: [lon, lat], zoom: 13, essential: true });
                    }
                }
            });

            async function queryOtx(ioc, apiType, guiType) {
                otxResult.innerHTML = '';
                otxLoader.classList.remove('hidden');
                try {
                    const response = await fetch(`${BACKEND_URL}/api/scan`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ioc, apiType })
                    });
                    if (response.status === 404) {
                       otxResult.innerHTML = `<p class="text-yellow-400">IOC not found.</p>`;
                       return;
                    }
                    if (!response.ok) throw new Error(`API request failed: ${response.status}`);
                    
                    const result = await response.json();
                    displayOtxResult(result, ioc, guiType);

                    let ipToGeolocate = null;
                    let popupDetails = `<strong>IOC:</strong><br>${ioc}`;

                    if (apiType === 'IPv4') {
                        ipToGeolocate = ioc;
                    } else if (apiType === 'domain' && result.passive_dns?.length > 0) {
                        const aRecord = result.passive_dns.find(r => r.record_type === 'A');
                        if (aRecord) {
                            ipToGeolocate = aRecord.address;
                            popupDetails += `<br><strong>Resolved IP:</strong> ${ipToGeolocate}`;
                        }
                    }

                    if (ipToGeolocate) {
                        geolocateAndPlot(ipToGeolocate, popupDetails, ioc);
                    }
                } catch (error) {
                    otxResult.innerHTML = `<p class="text-red-500">Scan Error: ${error.message}`;
                } finally {
                    otxLoader.classList.add('hidden');
                }
            }
            
            async function geolocateAndPlot(ip, popupDetails, originalIoc) {
                try {
                    const response = await fetch(`https://ipapi.co/${ip}/json/`);
                    if (!response.ok) return;
                    const geoData = await response.json();
                    if (geoData && !geoData.error) {
                        const { latitude, longitude, city, country_name } = geoData;

                        // Remove existing plotted threat if present
                        if (plottedThreats[originalIoc]) {
                            const prev = plottedThreats[originalIoc];
                            // remove marker
                            if (prev.marker && typeof prev.marker.remove === 'function') prev.marker.remove();
                            // remove layers and sources if present
                            if (prev.fillLayerId && map.getLayer && map.getLayer(prev.fillLayerId)) map.removeLayer(prev.fillLayerId);
                            if (prev.lineLayerId && map.getLayer && map.getLayer(prev.lineLayerId)) map.removeLayer(prev.lineLayerId);
                            if (prev.sourceId && map.getSource && map.getSource(prev.sourceId)) map.removeSource(prev.sourceId);
                        }

                        // Build turf circle (GeoJSON) around the point
                        const center = turf.point([longitude, latitude]);
                        const radiusKm = 1; // 1 km radius
                        const options = { steps: 64, units: 'kilometers' };
                        const circle = turf.buffer(center, radiusKm, options);

                        // Ensure style is loaded before adding sources/layers
                        await ensureStyleLoaded();

                        // Add circle as a GeoJSON source and two layers (fill + outline)
                        const sourceId = safeId('circleSource', originalIoc);
                        const fillLayerId = safeId('circleFill', originalIoc);
                        const lineLayerId = safeId('circleLine', originalIoc);

                        if (!map.getSource(sourceId)) {
                            map.addSource(sourceId, { type: 'geojson', data: circle });
                        } else {
                            map.getSource(sourceId).setData(circle);
                        }

                        if (!map.getLayer(fillLayerId)) {
                            map.addLayer({
                                id: fillLayerId,
                                type: 'fill',
                                source: sourceId,
                                paint: { 'fill-color': '#f87171', 'fill-opacity': 0.12 }
                            });
                        }

                        if (!map.getLayer(lineLayerId)) {
                            map.addLayer({
                                id: lineLayerId,
                                type: 'line',
                                source: sourceId,
                                paint: { 'line-color': '#f87171', 'line-width': 2, 'line-opacity': 0.6 }
                            });
                        }

                        // Create a custom HTML marker (SVG) for the threat
                        const el = document.createElement('div');
                        el.className = 'threat-marker';
                        el.style.width = '36px';
                        el.style.height = '36px';
                        el.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#f87171" width="36" height="36"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>`;

                        const popupHtml = `<div class="text-base"><h4 class="font-bold text-lg">${city || ''}, ${country_name || ''}</h4><p class="font-mono">${popupDetails}</p></div>`;
                        const popup = new maplibregl.Popup({ offset: 25 }).setHTML(popupHtml);

                        const marker = new maplibregl.Marker(el).setLngLat([longitude, latitude]).setPopup(popup).addTo(map);
                        // open popup immediately
                        popup.addTo(map);

                        map.flyTo({ center: [longitude, latitude], zoom: 13, essential: true });

                        plottedThreats[originalIoc] = {
                            lat: latitude,
                            lon: longitude,
                            marker,
                            sourceId,
                            fillLayerId,
                            lineLayerId
                        };
                        updateThreatList();
                    }
                } catch (error) { console.warn('Geolocation failed:', error); }
            }
            
            function updateThreatList() {
                threatList.innerHTML = '';
                const threats = Object.keys(plottedThreats);
                if (threats.length === 0) {
                    threatList.appendChild(threatPlaceholder);
                    return;
                }
                threats.forEach(ioc => {
                    const li = document.createElement('li');
                    li.className = 'threat-list-item p-2 rounded-md cursor-pointer transition-colors flex items-center justify-between';
                    li.dataset.ioc = ioc;
                    li.innerHTML = `
                        <div>
                            <span class="font-mono text-blue-400">${ioc}</span>
                        </div>
                        <i class="fa-solid fa-crosshairs text-gray-500"></i>
                    `;
                    threatList.appendChild(li);
                });
            }

            function displayOtxResult(data, originalIoc, guiType) {
                const pulseCount = data.pulse_info.count;
                const permalink = `https://otx.alienvault.com/indicator/${guiType}/${originalIoc}`;
                let pulseColor = pulseCount > 0 ? 'text-red-500' : 'text-green-500';
                let pulseText = pulseCount > 0 ? `Associated with ${pulseCount} threat pulse(s).` : "Not associated with known threats.";
                otxResult.innerHTML = `
                    <h4 class="text-lg font-bold mb-2">Scan for: <span class="text-blue-400 font-mono break-all">${originalIoc}</span></h4>
                    <div class="space-y-1 text-md">
                        <p class="text-xl font-bold ${pulseColor}">${pulseText}</p>
                        <p class="text-gray-400 pt-2">A "pulse" is a report or collection of IOCs related to a threat.</p>
                    </div>
                    <a href="${permalink}" target="_blank" class="mt-4 inline-block text-blue-400 hover:underline">View Full Report on OTX &rarr;</a>`;
            }
        });
    </script>
</body>
</html>

